import re
from typing import Optional
from data import SCHOOLS


def normalize(text: str) -> str:
    text = text.lower().strip()
    text = re.sub(r"[Ø£Ø¥Ø¢Ø§]", "Ø§", text)
    text = re.sub(r"[Ù‰ÙŠ]", "ÙŠ", text)
    text = re.sub(r"Ø©", "Ù‡", text)
    text = re.sub(r"\s+", " ", text)
    return text


def contains(haystack: str, needle: str) -> bool:
    return normalize(needle) in normalize(haystack)


def _status_badge(status: str) -> str:
    colors = {
        "ØªÙ‚Ø¨Ù„ Ø·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯": ("ğŸŸ¢", "#1a7a4a"),
        "Ù„Ø§ ØªÙ‚Ø¨Ù„ Ø·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯": ("ğŸ”´", "#b91c1c"),
        "ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªØ§": ("ğŸŸ¡", "#b45309"),
    }
    icon, _ = colors.get(status, ("âšª", "#64748b"))
    return f"{icon} {status}"


def school_card(s: dict) -> str:
    map_link = f"[ğŸ“ Ø®Ø±ÙŠØ·Ø©]({s['map']})" if s.get("map") else ""
    factory = "ğŸ­ Ø¯Ø§Ø®Ù„ Ù…ØµÙ†Ø¹" if s.get("factory") == "Ù†Ø¹Ù…" else ""
    parts = [f"### ğŸ“š {s['name']}"]
    parts.append(f"**Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:** {s['gov']} â€” {s['city']}")
    parts.append(f"**Ø§Ù„ØªØ®ØµØµ:** {s['spec']}")
    parts.append(f"**Ø§Ù„Ø­Ø§Ù„Ø©:** {_status_badge(s['status'])}")
    parts.append(f"**Ù†Ø·Ø§Ù‚ Ø§Ù„Ù‚Ø¨ÙˆÙ„:** {s['scope']}")
    parts.append(f"**Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©:** {s['year']}")
    if s.get("addr"):
        parts.append(f"**Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:** {s['addr']}")
    extras = "  ".join(filter(None, [map_link, factory]))
    if extras:
        parts.append(extras)
    parts.append("---")
    return "\n".join(parts)


SPEC_GROUPS = [
    (["Ø¨Ø±Ù…Ø¬ÙŠØ§Øª", "Ø¨Ø±Ù…Ø¬Ù‡", "Ø¨Ø±Ù…Ø¬Ø©", "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", "Ø­Ø§Ø³Ø¨", "ntg", "software", "it"], "Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª"),
    (["Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", "Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", "ai"], "Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"),
    (["ÙƒÙ‡Ø±Ø¨Ø§Ø¡", "ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠÙ‡", "ÙƒÙ‡Ø±Ø¨ÙŠÙ‡", "Ø§Ù„Ø·Ø§Ù‚Ù‡", "Ø§Ù„Ø·Ø§Ù‚Ø©"], "Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ§Ù„Ø·Ø§Ù‚Ø©"),
    (["Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§", "Ù…ÙŠÙƒØ§Ù†ÙŠÙƒ"], "Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§"),
    (["Ø§ØªØµØ§Ù„Ø§Øª", "Ø´Ø¨ÙƒØ§Øª", "we", "ÙˆÙŠ"], "Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª"),
    (["Ø³ÙŠØ§Ø±Ø§Øª", "ØµÙŠØ§Ù†Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª", "ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª", "automotive"], "ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª"),
    (["ÙÙ†Ø¯Ù‚", "ÙÙ†Ø¯Ù‚Ù‡", "ÙÙ†Ø¯Ù‚Ø©", "Ø³ÙŠØ§Ø­"], "Ø§Ù„ÙÙ†Ø¯Ù‚Ø© ÙˆØ§Ù„Ø³ÙŠØ§Ø­Ø©"),
    (["Ø²Ø±Ø§Ø¹", "Ù†Ø¨Ø§ØªÙŠ", "Ø­ÙŠÙˆØ§Ù†ÙŠ", "Ø²Ø±Ø§Ø¹Ù‡", "Ø²Ø±Ø§Ø¹Ø©"], "Ø§Ù„Ø²Ø±Ø§Ø¹Ø©"),
    (["Ø¯ÙˆØ§Ø¡", "ØµÙŠØ¯Ù„", "Ø¯ÙˆØ§Ø¦ÙŠ", "Ø¯ÙˆØ§Ø¦ÙŠÙ‡"], "Ø§Ù„ØµÙ†Ø§Ø¹Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠØ©"),
    (["ØºØ°Ø§Ø¡", "ØºØ°Ø§Ø¦ÙŠ", "Ø§ØºØ°ÙŠÙ‡", "Ø§ØºØ°ÙŠØ©", "Ø§Ù„Ø§Ù„Ø¨Ø§Ù†", "Ø·Ø¹Ø§Ù…"], "Ø§Ù„ØµÙ†Ø§Ø¹Ø§Øª Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©"),
    (["Ù…Ù„Ø§Ø¨Ø³", "Ù†Ø³ÙŠØ¬", "Ø®ÙŠØ§Ø·Ù‡", "Ø®ÙŠØ§Ø·Ø©"], "Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ ÙˆØ§Ù„Ù†Ø³ÙŠØ¬"),
    (["Ø·Ø§Ù‚Ù‡ Ø´Ù…Ø³ÙŠÙ‡", "Ø·Ø§Ù‚Ø© Ø´Ù…Ø³ÙŠØ©", "Ø´Ù…Ø³", "solar"], "Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©"),
    (["Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª", "Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ø§Ù…Ø¯Ø§Ø¯", "ØªÙˆØ±ÙŠØ¯", "Ù„ÙˆØ¬Ø³ØªÙŠÙƒ"], "Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª ÙˆØ³Ù„Ø§Ø³Ù„ Ø§Ù„Ø¥Ù…Ø¯Ø§Ø¯"),
    (["Ø­Ù„ÙŠ", "Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª", "Ø°Ù‡Ø¨", "gold"], "ØµÙ†Ø§Ø¹Ø© Ø§Ù„Ø­Ù„ÙŠ ÙˆØ§Ù„Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª"),
    (["Ø·Ø§Ø¦Ø±Ø§Øª", "aviation", "Ø·ÙŠØ§Ø±Ø§Øª"], "ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø¦Ø±Ø§Øª"),
    (["cnc", "Ø±ÙˆØ¨ÙˆØª"], "Ø§Ù„Ø±ÙˆØ¨ÙˆØªØ§Øª Ùˆ CNC"),
    (["ØªØ¨Ø±ÙŠØ¯", "ØªÙƒÙŠÙŠÙ"], "Ø§Ù„ØªØ¨Ø±ÙŠØ¯ ÙˆØ§Ù„ØªÙƒÙŠÙŠÙ"),
    (["Ù„Ø­Ø§Ù…", "Ø­Ø¯Ø§Ø¯Ù‡"], "Ø§Ù„Ù„Ø­Ø§Ù…"),
]

GOV_ALIASES = [
    (["Ø§Ù„Ù‚Ø§Ù‡Ø±Ù‡", "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "cairo"], "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©"),
    (["Ø§Ù„Ø¬ÙŠØ²Ù‡", "Ø§Ù„Ø¬ÙŠØ²Ø©", "giza", "Ø§ÙƒØªÙˆØ¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ø²Ø§ÙŠØ¯"], "Ø§Ù„Ø¬ÙŠØ²Ø©"),
    (["Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠÙ‡", "Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠÙ‡", "alex"], "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©"),
    (["Ø§Ù„Ø´Ø±Ù‚ÙŠÙ‡", "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©", "sharqia", "Ø²Ù‚Ø§Ø²ÙŠÙ‚", "Ø±Ù…Ø¶Ø§Ù†"], "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©"),
    (["Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠÙ‡", "Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©", "qalyubia", "Ø¹Ø¨ÙˆØ±"], "Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©"),
    (["Ø§Ù„ØºØ±Ø¨ÙŠÙ‡", "Ø§Ù„ØºØ±Ø¨ÙŠØ©", "Ø·Ù†Ø·Ø§", "gharbiya"], "Ø§Ù„ØºØ±Ø¨ÙŠØ©"),
    (["Ø§Ù„Ù…Ù†ÙˆÙÙŠÙ‡", "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©", "Ù…Ù†ÙˆÙÙŠÙ‡", "Ø³Ø§Ø¯Ø§Øª"], "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©"),
    (["Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠÙ‡", "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©", "Ø§Ù„Ù…Ù†ØµÙˆØ±Ù‡", "Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©"], "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©"),
    (["Ø§Ù„Ù…Ù†ÙŠØ§", "minya"], "Ø§Ù„Ù…Ù†ÙŠØ§"),
    (["Ø§Ø³ÙŠÙˆØ·", "Ø£Ø³ÙŠÙˆØ·", "assiut"], "Ø£Ø³ÙŠÙˆØ·"),
    (["Ø³ÙˆÙ‡Ø§Ø¬", "sohag"], "Ø³ÙˆÙ‡Ø§Ø¬"),
    (["Ù‚Ù†Ø§", "qena", "Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ", "Ù†Ø¬Ø¹"], "Ù‚Ù†Ø§"),
    (["Ø§Ù„Ø§Ù‚ØµØ±", "Ø§Ù„Ø£Ù‚ØµØ±", "luxor", "Ø§Ù„Ø£Ù‚ØµØ±"], "Ø§Ù„Ø£Ù‚ØµØ±"),
    (["Ø§Ø³ÙˆØ§Ù†", "Ø£Ø³ÙˆØ§Ù†", "aswan"], "Ø£Ø³ÙˆØ§Ù†"),
    (["Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯", "port said", "Ø¨ÙˆØ± Ø³Ø¹ÙŠØ¯"], "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯"),
    (["Ø§Ù„Ø³ÙˆÙŠØ³", "suez"], "Ø§Ù„Ø³ÙˆÙŠØ³"),
    (["Ø§Ù„Ø§Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠÙ‡", "Ø§Ù„Ø§Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©", "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©", "Ø§Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠÙ‡"], "Ø§Ù„Ø§Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©"),
    (["Ø¯Ù…ÙŠØ§Ø·", "damietta"], "Ø¯Ù…ÙŠØ§Ø·"),
    (["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®", "kafr", "ÙƒÙØ±Ø§Ù„Ø´ÙŠØ®"], "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®"),
    (["Ø§Ù„Ø¨Ø­ÙŠØ±Ù‡", "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©", "beheira", "Ø¯Ù…Ù†Ù‡ÙˆØ±"], "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©"),
    (["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ", "Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ", "beni suef"], "Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ"),
    (["Ø§Ù„ÙÙŠÙˆÙ…", "fayoum"], "Ø§Ù„ÙÙŠÙˆÙ…"),
    (["Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯", "Ø§Ù„ÙˆØ§Ø¯Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯", "ÙˆØ§Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯"], "Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯"),
    (["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­", "Ù…Ø·Ø±ÙˆØ­", "matrouh"], "Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­"),
    (["Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡", "Ø³ÙŠÙ†Ø§Ø¡", "sinai", "Ø§Ù„Ø·ÙˆØ±"], "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡"),
    (["Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡", "Ø§Ù„Ø¹Ø±ÙŠØ´"], "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡"),
    (["Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø§Ø­Ù…Ø±", "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±", "Ø§Ù„ØºØ±Ø¯Ù‚Ù‡", "Ø§Ù„ØºØ±Ø¯Ù‚Ø©", "red sea"], "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø§Ø­Ù…Ø±"),
]


def process_query(q: str) -> str:
    nq = normalize(q)

    # GREETINGS
    if re.match(r"^(Ù…Ø±Ø­Ø¨|Ù‡Ù„Ø§|Ø§Ù‡Ù„Ø§|Ø³Ù„Ø§Ù…|ØµØ¨Ø§Ø­|Ù…Ø³Ø§Ø¡|hi|hello|Ø§Ù„Ø³Ù„Ø§Ù…)", nq):
        return (
            "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹\n\n"
            "Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ©. ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:\n\n"
            "- ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø§Ø±Ø³ ÙÙŠ Ù…Ø­Ø§ÙØ¸ØªÙƒ\n"
            "- ğŸ¯ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡\n"
            "- âœ… Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙŠ ØªÙ‚Ø¨Ù„ Ø·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯\n"
            "- ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø£ÙŠ Ù…Ø¯Ø±Ø³Ø© Ø¨Ø§Ù„Ø§Ø³Ù…\n"
            "- ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø© Ø¹Ù† Ø§Ù„Ù…Ø¯Ø§Ø±Ø³\n\n"
            "Ø§Ø³Ø£Ù„ Ø¨Ø­Ø±ÙŠØ©!"
        )

    # TOTAL COUNT
    if re.search(r"ÙƒÙ… (Ø¹Ø¯Ø¯|Ù…Ø¯Ø±Ø³Ù‡|Ù…Ø¯Ø±Ø³Ø©)|Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³|ÙƒÙ… Ù…Ø¯Ø±Ø³Ù‡", nq):
        accepting = sum(1 for s in SCHOOLS if s["status"] == "ØªÙ‚Ø¨Ù„ Ø·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯")
        return (
            f"ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ **{len(SCHOOLS)}** Ù…Ø¯Ø±Ø³Ø© ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ ØªØ·Ø¨ÙŠÙ‚ÙŠØ© ÙÙŠ Ù…ØµØ±.\n\n"
            f"- âœ… **{accepting}** Ù…Ø¯Ø±Ø³Ø© ØªÙ‚Ø¨Ù„ Ø·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯\n"
            f"- âŒ **{len(SCHOOLS) - accepting}** Ù„Ø§ ØªÙ‚Ø¨Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹"
        )

    # CONDITIONS (must come before ACCEPTING to avoid "Ø´Ø±ÙˆØ· Ø§Ù„Ù‚Ø¨ÙˆÙ„" mismatch)
    if re.search(r"Ø´Ø±ÙˆØ·|Ù…ØªØ·Ù„Ø¨Ø§Øª|ÙƒÙŠÙ Ø§ØªÙ‚Ø¯Ù…|ÙƒÙŠÙÙŠÙ‡|Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…", nq):
        return (
            "## Ø´Ø±ÙˆØ· Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙÙŠ Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ©\n\n"
            "**Ø´Ø±ÙˆØ· Ø§Ù„Ø·Ø§Ù„Ø¨:**\n"
            "- Ø®Ø±ÙŠØ¬ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© (Ø¹Ø§Ù…Ø© Ø£Ùˆ Ø£Ø²Ù‡Ø±ÙŠØ©)\n"
            "- Ø£Ù„Ø§ ÙŠØ²ÙŠØ¯ Ø§Ù„Ø³Ù† Ø¹Ù† **18 Ø³Ù†Ø©**\n"
            "- Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ù„Ù…Ø¯Ø±Ø³Ø©\n"
            "- Ø®Ø±ÙŠØ¬ Ù†ÙØ³ Ø§Ù„Ø¹Ø§Ù… Ø£Ùˆ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ù‡\n\n"
            "**Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…:**\n"
            "1. Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù„Ù‰ **Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙÙ†ÙŠ** ÙˆØªØ­Ø¯ÙŠØ¯ 3 Ø±ØºØ¨Ø§Øª\n"
            "2. Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø±ÙŠØ§Ø¶ÙŠØ§Øª + Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ + Ø¹Ø±Ø¨ÙŠ + Ø°ÙƒØ§Ø¡)\n"
            "3. Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© ÙÙŠ Ø§Ù„Ø±ØºØ¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰\n"
            "4. Ø§Ù„Ø§Ù„ØªØ­Ø§Ù‚ Ø¨Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ØªÙŠ Ù†Ø¬Ø­ ÙÙŠÙ‡Ø§"
        )

    # ACCEPTING â€” optionally filtered by governorate
    if re.search(r"ØªÙ‚Ø¨Ù„ Ø·Ù„Ø§Ø¨|Ù…ØªØ§Ø­|Ù…ÙØªÙˆØ­", nq) and not re.search(r"Ù„Ø§ ØªÙ‚Ø¨Ù„|Ù…Ø´ ØªÙ‚Ø¨Ù„", nq):
        accepting = [s for s in SCHOOLS if s["status"] == "ØªÙ‚Ø¨Ù„ Ø·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯"]
        gov_name = _extract_gov(nq)
        if gov_name:
            accepting = [s for s in accepting if contains(s["gov"], gov_name) or contains(s["scope"], gov_name)]
            if not accepting:
                return f"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯Ø§Ø±Ø³ ØªÙ‚Ø¨Ù„ Ø·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯ ÙÙŠ **{gov_name}** Ø­Ø§Ù„ÙŠØ§Ù‹."
            return f"**{len(accepting)}** Ù…Ø¯Ø±Ø³Ø© ØªÙ‚Ø¨Ù„ Ø·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯ ÙÙŠ **{gov_name}**:\n\n" + "\n".join(school_card(s) for s in accepting)
        preview = accepting[:8]
        tail = f"\n\n> ...Ùˆ{len(accepting) - 8} Ù…Ø¯Ø§Ø±Ø³ Ø£Ø®Ø±Ù‰. Ø­Ø¯Ø¯ Ù…Ø­Ø§ÙØ¸Ø© Ù„Ù„ØªØ¶ÙŠÙŠÙ‚." if len(accepting) > 8 else ""
        return f"**{len(accepting)}** Ù…Ø¯Ø±Ø³Ø© ØªÙ‚Ø¨Ù„ Ø·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯:\n\n" + "\n".join(school_card(s) for s in preview) + tail

    # FACTORY
    if re.search(r"Ø¯Ø§Ø®Ù„ Ù…ØµÙ†Ø¹|Ù…ØµÙ†Ø¹", nq):
        results = [s for s in SCHOOLS if s["factory"] == "Ù†Ø¹Ù…"]
        return f"**{len(results)}** Ù…Ø¯Ø±Ø³Ø© ØªÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Ù…ØµÙ†Ø¹:\n\n" + "\n".join(school_card(s) for s in results)

    # ALL GOVERNORATES TABLE
    if re.search(r"Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª|Ù‚Ø§Ø¦Ù…Ù‡ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª|ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª|Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª", nq):
        from collections import Counter
        gov_count = Counter(s["gov"] for s in SCHOOLS)
        rows = "\n".join(f"| {g} | {c} |" for g, c in sorted(gov_count.items(), key=lambda x: -x[1]))
        return (
            f"Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù…ÙˆØ²Ø¹Ø© Ø¹Ù„Ù‰ **{len(gov_count)}** Ù…Ø­Ø§ÙØ¸Ø©:\n\n"
            "| Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© | Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ |\n"
            "|---------|-------------|\n"
            + rows
        )

    # SPECIFIC SCHOOL BY NAME
    for s in SCHOOLS:
        short = re.sub(r"^(Ù…Ø¯Ø±Ø³Ù‡|Ù…Ø¯Ø±Ø³Ø©)\s*", "", s["name"]).strip()
        if contains(s["name"], q) or (len(q) > 4 and contains(q, short)):
            return (
                f"**ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:**\n\n{school_card(s)}\n"
                f"**ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„:** {s['proto'] or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}"
            )

    # SPECIALIZATION SEARCH
    for keywords, label in SPEC_GROUPS:
        if any(normalize(k) in nq for k in keywords):
            results = [s for s in SCHOOLS if any(contains(s["spec"], k) or contains(s["name"], k) for k in keywords)]
            if results:
                return f"ÙˆØ¬Ø¯Øª **{len(results)}** Ù…Ø¯Ø±Ø³Ø© ÙÙŠ ØªØ®ØµØµ **{label}**:\n\n" + "\n".join(school_card(s) for s in results)

    # GOVERNORATE SEARCH
    gov_result = _search_by_gov(nq)
    if gov_result:
        return gov_result

    # YEAR SEARCH
    year_m = re.search(r"20\d\d", q)
    if year_m:
        yr = year_m.group()
        results = [s for s in SCHOOLS if yr in s["year"] or yr in s.get("proto", "")]
        if results:
            return f"ÙˆØ¬Ø¯Øª **{len(results)}** Ù…Ø¯Ø±Ø³Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø³Ù†Ø© **{yr}**:\n\n" + "\n".join(school_card(s) for s in results)

    # ATS INFO
    if re.search(r"Ù…Ø§ Ù‡ÙŠ|Ù…Ø§Ù‡ÙŠ|ØªØ¹Ø±ÙŠÙ|Ù…Ø¹Ù„ÙˆÙ…Ø§Øª|Ø¹Ù† Ù…Ø¯Ø§Ø±Ø³|ats|Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠÙ‡", nq):
        return (
            "## Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ© (ATS)\n\n"
            "Ù…Ø¯Ø§Ø±Ø³ Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙÙ†ÙŠ ØªØ¹Ù…Ù„ ÙˆÙÙ‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¯ÙˆÙ„ÙŠØ© Ø¨Ø´Ø±Ø§ÙƒØ© Ø¨ÙŠÙ† ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø®Ø§Øµ.\n\n"
            "**Ø£Ø¨Ø±Ø² Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**\n"
            "- ğŸ“œ Ø§Ù„Ø®Ø±ÙŠØ¬ ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ **3 Ø´Ù‡Ø§Ø¯Ø§Øª**: ÙˆØ²Ø§Ø±ÙŠØ© + Ø®Ø¨Ø±Ø© ØµÙ†Ø§Ø¹ÙŠØ© + Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¯ÙˆÙ„ÙŠ\n"
            "- ğŸ’¼ 53% Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ¬ÙŠÙ† Ø§Ù„ØªØ­Ù‚ÙˆØ§ Ø¨Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ù…Ù„\n"
            "- ğŸ“ 43% Ø§Ù„ØªØ­Ù‚ÙˆØ§ Ø¨Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ø§Ù‡Ø¯\n"
            "- ğŸŒ 18% Ø­ØµÙ„ÙˆØ§ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¯ÙˆÙ„ÙŠ\n"
            "- ğŸ“– ØªØ¯Ø±ÙŠØ³ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙƒÙ„ØºØ© Ø£ÙˆÙ„Ù‰\n"
            "- ğŸ« Ø¨Ø¯Ø£Øª 2018 ÙˆØªØ³ØªÙ‡Ø¯Ù Ø£ÙƒØ«Ø± Ù…Ù† 200 Ù…Ø¯Ø±Ø³Ø©"
        )

    # CERTIFICATES
    if re.search(r"Ø´Ù‡Ø§Ø¯|Ø§Ø¹ØªÙ…Ø§Ø¯|Ù…Ø¤Ù‡Ù„|Ø®Ø±ÙŠØ¬", nq):
        return (
            "## Ø´Ù‡Ø§Ø¯Ø§Øª Ø®Ø±ÙŠØ¬ Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ©\n\n"
            "ÙŠØ­ØµÙ„ Ø§Ù„Ø®Ø±ÙŠØ¬ Ø¹Ù„Ù‰ **3 Ø´Ù‡Ø§Ø¯Ø§Øª**:\n\n"
            "ğŸ« **Ø´Ù‡Ø§Ø¯Ø© ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…**  \n"
            "Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ© Ø§Ù„Ø±Ø³Ù…ÙŠØ©\n\n"
            "ğŸ­ **Ø´Ù‡Ø§Ø¯Ø© Ø®Ø¨Ø±Ø© Ù…Ù† Ø§Ù„Ø´Ø±ÙŠÙƒ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ**  \n"
            "ØªØ«Ø¨Øª Ø§Ù„ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ© ÙÙŠ Ø§Ù„Ù…ØµÙ†Ø¹\n\n"
            "ğŸŒ **Ø´Ù‡Ø§Ø¯Ø© Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¯ÙˆÙ„ÙŠ**  \n"
            "18% Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ¬ÙŠÙ† Ø­ØµÙ„ÙˆØ§ Ø¹Ù„ÙŠÙ‡Ø§"
        )

    # FUZZY FALLBACK
    results = [
        s for s in SCHOOLS
        if contains(s["name"], q) or contains(s["spec"], q)
        or contains(s["city"], q) or contains(s["addr"], q)
    ]
    if results:
        preview = results[:10]
        tail = f"\n\n> ...Ùˆ{len(results) - 10} Ù†ØªØ§Ø¦Ø¬ Ø£Ø®Ø±Ù‰. Ø­Ø¯Ø¯ Ø¨Ø­Ø«Ùƒ Ù„Ù„Ù…Ø²ÙŠØ¯." if len(results) > 10 else ""
        return f"ÙˆØ¬Ø¯Øª **{len(results)}** Ù†ØªÙŠØ¬Ø© Ù„Ù€ **\"{q}\"**:\n\n" + "\n".join(school_card(s) for s in preview) + tail

    return (
        f"Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£Ø¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ø¶Ø­Ø© Ù„Ù€ **\"{q}\"**.\n\n"
        "Ø¬Ø±Ø¨ Ù…Ø«Ù„Ø§Ù‹:\n"
        "- Ø§Ø³Ù… Ù…Ø­Ø§ÙØ¸Ø©: *Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ø§Ù„Ø¬ÙŠØ²Ø©ØŒ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©...*\n"
        "- ØªØ®ØµØµ: *Ø¨Ø±Ù…Ø¬Ø©ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ ÙÙ†Ø¯Ù‚Ø©ØŒ Ø³ÙŠØ§Ø±Ø§Øª...*\n"
        "- Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙƒØ§Ù…Ù„Ø§Ù‹ Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù†Ù‡"
    )


def _extract_gov(nq: str) -> Optional[str]:
    for aliases, name in GOV_ALIASES:
        if any(normalize(a) in nq for a in aliases):
            return name
    return None


def _search_by_gov(nq: str) -> Optional[str]:
    for aliases, name in GOV_ALIASES:
        if any(normalize(a) in nq for a in aliases):
            results = [
                s for s in SCHOOLS
                if contains(s["gov"], name) or any(contains(s["gov"], a) or contains(s["city"], a) for a in aliases)
            ]
            if not results:
                return f"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯Ø§Ø±Ø³ Ù…Ø³Ø¬Ù„Ø© ÙÙŠ **{name}** Ø­Ø§Ù„ÙŠØ§Ù‹."
            return f"ÙˆØ¬Ø¯Øª **{len(results)}** Ù…Ø¯Ø±Ø³Ø© ÙÙŠ **{name}**:\n\n" + "\n".join(school_card(s) for s in results)
    return None
