import streamlit as st
import anthropic
import pandas as pd
import csv
import io
import os

# â”€â”€ Page config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="CatBot â€“ Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ©",
    page_icon="ğŸ«",
    layout="wide",
)

# â”€â”€ Global CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap');

html, body, [class*="css"] { font-family: 'Cairo', sans-serif !important; direction: rtl; }
#MainMenu, footer, header { visibility: hidden; }
.stApp { background: #f5f7fa; }

.hero {
    background: linear-gradient(135deg, #0a3d1f 0%, #1a6b3c 50%, #27ae60 100%);
    border-radius: 20px;
    padding: 32px 40px;
    margin-bottom: 20px;
    text-align: center;
    color: white;
    box-shadow: 0 8px 32px rgba(26,107,60,0.35);
}
.hero h1 { margin: 0; font-size: 2rem; font-weight: 800; }
.hero p  { margin: 10px 0 0; font-size: 1rem; opacity: 0.88; }
.hero .badge {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 20px;
    padding: 4px 14px;
    font-size: 0.8rem;
    margin-top: 10px;
}

.stat-card {
    background: white;
    border-radius: 14px;
    padding: 14px 16px;
    text-align: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    border-top: 3px solid #27ae60;
    margin-bottom: 8px;
}
.stat-card .num { font-size: 1.8rem; font-weight: 800; color: #1a6b3c; line-height: 1; }
.stat-card .lbl { font-size: 0.75rem; color: #666; margin-top: 4px; }

.stButton > button {
    background: white !important;
    color: #1a6b3c !important;
    border: 1.5px solid #c8e6c9 !important;
    border-radius: 10px !important;
    font-family: 'Cairo', sans-serif !important;
    font-size: 0.82rem !important;
    padding: 6px 10px !important;
    text-align: right !important;
    direction: rtl !important;
    width: 100% !important;
    transition: all 0.2s !important;
}
.stButton > button:hover {
    background: #e8f5e9 !important;
    border-color: #27ae60 !important;
    color: #0a3d1f !important;
}

.stChatMessage { direction: rtl; text-align: right; }
.stChatMessage p { line-height: 1.9; font-size: 0.97rem; }

.stChatInput textarea {
    direction: rtl !important;
    text-align: right !important;
    font-family: 'Cairo', sans-serif !important;
    border-radius: 14px !important;
}

.welcome-card {
    background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
    border: 1.5px solid #a5d6a7;
    border-radius: 16px;
    padding: 20px 24px;
    margin-bottom: 16px;
    text-align: right;
    direction: rtl;
}
.welcome-card h3 { color: #1a6b3c; margin: 0 0 8px; font-size: 1.05rem; }
.welcome-card p  { color: #2d5a27; margin: 0; font-size: 0.9rem; line-height: 1.7; }

.sidebar-section {
    background: #f9fafb;
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 14px;
    border: 1px solid #ececec;
}
.sidebar-section h4 {
    color: #1a6b3c;
    margin: 0 0 10px;
    font-size: 0.9rem;
    font-weight: 700;
    border-bottom: 2px solid #c8e6c9;
    padding-bottom: 6px;
}

[data-testid="stSidebar"] { background: white !important; }
</style>
""", unsafe_allow_html=True)


# â”€â”€ CSV loader with robust fix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data
def load_data():
    try:
        base_dir = os.path.dirname(os.path.abspath(__file__))
    except NameError:
        base_dir = os.getcwd()
    csv_path = os.path.join(base_dir, "schools_data.csv")
    with open(csv_path, encoding="utf-8-sig") as f:
        content = f.read()

    reader = csv.reader(io.StringIO(content))
    header = next(reader)   # 12 columns
    raw_rows = list(reader)

    def fix_row(row):
        if len(row) == 12:
            return row
        if len(row) <= 1:
            return None
        # First 8 cols and last 2 cols are stable; middle varies due to GPS coord split
        prefix = row[:8]
        suffix = row[-2:]
        middle = row[8:-2]
        if not middle:
            return prefix + ["", ""] + list(suffix)
        nataq = middle[-1]
        map_parts = middle[:-1]
        map_url = ",".join(
            p for p in map_parts
            if any(c in p for c in ["http", "maps", "goo.gl", ".", "0","1","2","3","4","5","6","7","8","9"])
        )
        if any(c in nataq for c in ["http", "maps.app"]):
            map_url = (map_url + "," + nataq).strip(",")
            nataq = ""
        return prefix + [map_url, nataq] + list(suffix)

    fixed = [r for row in raw_rows if (r := fix_row(row)) is not None]
    return pd.DataFrame(fixed, columns=header)


df = load_data()


# â”€â”€ System prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data
def build_system_prompt(df: pd.DataFrame) -> str:
    lines = []
    for _, row in df.iterrows():
        lines.append(
            f"[{row['Ù…']}] {row['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']}\n"
            f"  Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©: {row['Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©']} | Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: {row['Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©']}\n"
            f"  Ø§Ù„ØªØ®ØµØµØ§Øª: {row['Ø§Ù„ØªØ®ØµØµ']}\n"
            f"  Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: {row['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†']}\n"
            f"  Ù†Ø·Ø§Ù‚ Ø§Ù„Ù‚Ø¨ÙˆÙ„: {row['Ù†Ø·Ø§Ù‚ Ø§Ù„Ù‚Ø¨ÙˆÙ„']}\n"
            f"  Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: {row['Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']}\n"
            f"  Ø¯Ø§Ø®Ù„ Ù…ØµÙ†Ø¹: {row['Ù…Ø¯Ø±Ø³Ø© Ø¯Ø§Ø®Ù„ Ù…ØµÙ†Ø¹']}\n"
            f"  Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©: {row['Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©']}\n"
        )
    return f"""Ø£Ù†Øª CatBotØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ© ÙÙŠ Ù…ØµØ±.

Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„:
- Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø¯ØŒ ØªØ­Ù‚Ù‚ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙˆÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„.
- Ø§Ù„ØªØ²Ù… Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø±Ø¯ Ø±Ø³Ù…ÙŠ ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ Ø¬Ø¯Ø§Ù‹ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
- Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ù…Ø¯Ø±Ø³Ø©ØŒ Ø§Ø¨Ø­Ø« Ø¹Ù† ØªØ®ØµØµØ§ØªÙ‡Ø§ØŒ Ø¹Ù†ÙˆØ§Ù†Ù‡Ø§ØŒ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø¨Ù‡Ø§ (ØªÙ‚Ø¨Ù„ Ø£Ùˆ Ù„Ø§ ØªÙ‚Ø¨Ù„) Ø¨Ø¯Ù‚Ø©.
- Ù„Ø§ ØªÙ‚Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ ÙÙŠÙ…Ø§ ÙŠØ®Øµ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³.
- Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨ Ù…Ù†Ùƒ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù…Ø¯Ø§Ø±Ø³ Ù…Ø­Ø§ÙØ¸Ø© Ø£Ùˆ ØªØ®ØµØµ Ù…Ø¹ÙŠÙ†ØŒ Ø§Ø¹Ø±Ø¶Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø¸Ù… Ù…Ø¹ Ø§Ù„ØªØ±Ù‚ÙŠÙ….
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù„ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.
- Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ØµØ±Ù‘Ø­ Ø¨Ø°Ù„Ùƒ Ø¨ÙˆØ¶ÙˆØ­.
- Ø¹Ù†Ø¯ Ø°ÙƒØ± Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©ØŒ Ù‚Ø¯Ù‘Ù…Ù‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©:
Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ© Ù‡ÙŠ Ù…Ø¯Ø§Ø±Ø³ Ø­ÙƒÙˆÙ…ÙŠØ© Ù†Ù…ÙˆØ°Ø¬ÙŠØ© ØªÙØ¯Ø§Ø± Ø¨Ø´Ø±Ø§ÙƒØ© Ø¨ÙŠÙ† ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø®Ø§Øµ.
ÙŠØ­ØµÙ„ Ø§Ù„Ø®Ø±ÙŠØ¬ Ø¹Ù„Ù‰ 3 Ø´Ù‡Ø§Ø¯Ø§Øª: Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© + ØªØ¯Ø±ÙŠØ¨ ØµÙ†Ø§Ø¹ÙŠ + Ø´Ù‡Ø§Ø¯Ø© Ø¯ÙˆÙ„ÙŠØ© Ù…Ø¹ØªÙ…Ø¯Ø©.
Ø¨Ø¯Ø£Øª Ø¹Ø§Ù… 2018 Ø¨Ù€3 Ù…Ø¯Ø§Ø±Ø³ ÙˆÙˆØµÙ„Øª Ø¥Ù„Ù‰ 115+ Ù…Ø¯Ø±Ø³Ø© ÙÙŠ 27 Ù…Ø­Ø§ÙØ¸Ø© Ø¨Ø­Ù„ÙˆÙ„ 2025/2026.

Ø´Ø±ÙˆØ· Ø§Ù„Ù‚Ø¨ÙˆÙ„:
- Ø®Ø±ÙŠØ¬ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© Ø¹Ø§Ù…Ø© Ø£Ùˆ Ø£Ø²Ù‡Ø±ÙŠØ© | Ù„Ø§ ÙŠØ²ÙŠØ¯ Ø³Ù†Ù‘Ù‡ Ø¹Ù† 18 Ø³Ù†Ø©
- Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ù„Ù…Ø¯Ø±Ø³Ø© | Ø§Ø¬ØªÙŠØ§Ø² Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙ…Ù‚Ø§Ø¨Ù„Ø© Ø´Ø®ØµÙŠØ©

Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…: ØªØ³Ø¬ÙŠÙ„ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ â† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±ØºØ¨Ø§Øª â† Ø§Ø®ØªØ¨Ø§Ø± â† Ù…Ù‚Ø§Ø¨Ù„Ø© â† Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù‚Ø¨ÙˆÙ„

=== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ÙƒØ§Ù…Ù„Ø© ===

{"".join(lines)}"""


SYSTEM_PROMPT = build_system_prompt(df)


# â”€â”€ Anthropic client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_resource
def get_client():
    key = os.environ.get("ANTHROPIC_API_KEY") or st.secrets.get("ANTHROPIC_API_KEY", "")
    return anthropic.Anthropic(api_key=key)


client = get_client()


# â”€â”€ Session state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages = []
if "pending" not in st.session_state:
    st.session_state.pending = None


# â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    accepting = len(df[df["Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"].str.contains("ØªÙ‚Ø¨Ù„", na=False)])

    st.markdown(f"""
    <div class="sidebar-section">
        <h4>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h4>
        <div class="stat-card"><div class="num">{len(df)}</div><div class="lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</div></div>
        <div class="stat-card"><div class="num">{df['Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©'].nunique()}</div><div class="lbl">Ù…Ø­Ø§ÙØ¸Ø©</div></div>
        <div class="stat-card"><div class="num">{accepting}</div><div class="lbl">ØªÙ‚Ø¨Ù„ Ø·Ù„Ø§Ø¨Ø§Ù‹ Ø§Ù„Ø¢Ù†</div></div>
    </div>
    """, unsafe_allow_html=True)

    st.markdown('<div class="sidebar-section"><h4>ğŸ’¡ Ø£Ø³Ø¦Ù„Ø© Ø³Ø±ÙŠØ¹Ø©</h4>', unsafe_allow_html=True)
    quick_qs = [
        ("ğŸ™ï¸", "Ù…Ø§ Ù‡ÙŠ Ù…Ø¯Ø§Ø±Ø³ Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŸ"),
        ("âš¡", "Ù…Ø§ Ù‡ÙŠ Ù…Ø¯Ø§Ø±Ø³ ØªØ®ØµØµ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŸ"),
        ("ğŸ’»", "Ù…Ø§ Ù‡ÙŠ Ù…Ø¯Ø§Ø±Ø³ ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„Ø­Ø§Ø³Ø¨Ø§ØªØŸ"),
        ("ğŸš—", "Ù…Ø§ Ù‡ÙŠ Ù…Ø¯Ø§Ø±Ø³ ØªØ®ØµØµ ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§ØªØŸ"),
        ("ğŸ“‹", "Ù…Ø§ Ù‡ÙŠ Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ù„ØªØ­Ø§Ù‚ Ø¨Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ØŸ"),
        ("ğŸ“", "Ù…Ø§ Ù‡ÙŠ Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ©ØŸ"),
        ("ğŸ“", "Ù…Ø§ Ù‡ÙŠ Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©ØŸ"),
        ("ğŸŒ¾", "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø°Ø§Øª Ø§Ù„ØªØ®ØµØµØ§Øª Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ©ØŸ"),
        ("ğŸ­", "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¯Ø§Ø®Ù„ Ù…ØµØ§Ù†Ø¹ØŸ"),
    ]
    for emoji, q in quick_qs:
        if st.button(f"{emoji} {q}", key=f"qbtn_{q}"):
            st.session_state.pending = q
            st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

    st.markdown('<div class="sidebar-section"><h4>ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</h4>', unsafe_allow_html=True)
    govs_list = sorted(df["Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©"].dropna().unique().tolist())
    selected_gov = st.selectbox("Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©", ["-- Ø§Ø®ØªØ± --"] + govs_list, label_visibility="collapsed")
    if selected_gov != "-- Ø§Ø®ØªØ± --":
        if st.button(f"Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø§Ø±Ø³ {selected_gov}", use_container_width=True, key="gov_search"):
            st.session_state.pending = f"Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ø­Ø§ÙØ¸Ø© {selected_gov}ØŸ"
            st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

    if st.button("ğŸ—‘ï¸  Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©", use_container_width=True, key="clear"):
        st.session_state.messages = []
        st.session_state.pending = None
        st.rerun()


# â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<div class="hero">
    <h1>ğŸ« CatBot â€” Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ©</h1>
    <p>Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ Ù…Ø¯Ø±Ø³Ø©: ØªØ®ØµØµØ§ØªÙ‡Ø§ Â· Ø¹Ù†ÙˆØ§Ù†Ù‡Ø§ Â· Ù†Ø·Ø§Ù‚ Ø§Ù„Ù‚Ø¨ÙˆÙ„ Â· Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</p>
    <span class="badge">ğŸŸ¢ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Â· Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</span>
</div>
""", unsafe_allow_html=True)

if not st.session_state.messages:
    st.markdown("""
    <div class="welcome-card">
        <h3>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ CatBot!</h3>
        <p>
        Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ <strong>Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ© ÙÙŠ Ù…ØµØ±</strong>.<br>
        ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø­Ø³Ø¨: Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Â· Ø§Ù„ØªØ®ØµØµ Â· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Â· Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¨ÙˆÙ„.<br>
        Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø¨Ø­Ø±ÙŠØ© â¬‡ï¸
        </p>
    </div>
    """, unsafe_allow_html=True)

# Render history
for msg in st.session_state.messages:
    with st.chat_message(msg["role"], avatar="ğŸ§‘â€ğŸ’»" if msg["role"] == "user" else "ğŸ¤–"):
        st.markdown(msg["content"])


def get_reply(messages_list):
    response = client.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=1500,
        system=SYSTEM_PROMPT,
        messages=messages_list,
    )
    return response.content[0].text


# Handle sidebar button presses
if st.session_state.pending:
    prompt = st.session_state.pending
    st.session_state.pending = None
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user", avatar="ğŸ§‘â€ğŸ’»"):
        st.markdown(prompt)
    with st.chat_message("assistant", avatar="ğŸ¤–"):
        with st.spinner("ğŸ” Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."):
            api_msgs = [{"role": m["role"], "content": m["content"]} for m in st.session_state.messages]
            reply = get_reply(api_msgs)
        st.markdown(reply)
    st.session_state.messages.append({"role": "assistant", "content": reply})
    st.rerun()

# Handle typed input
if prompt := st.chat_input("âœï¸  Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§â€¦ Ù…Ø«Ø§Ù„: Ù…Ø§ Ù…Ø¯Ø§Ø±Ø³ Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø¬ÙŠØ²Ø©ØŸ"):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user", avatar="ğŸ§‘â€ğŸ’»"):
        st.markdown(prompt)
    with st.chat_message("assistant", avatar="ğŸ¤–"):
        with st.spinner("ğŸ” Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."):
            api_msgs = [{"role": m["role"], "content": m["content"]} for m in st.session_state.messages]
            reply = get_reply(api_msgs)
        st.markdown(reply)
    st.session_state.messages.append({"role": "assistant", "content": reply})